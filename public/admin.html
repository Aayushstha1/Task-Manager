<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6b73ff, #000dff);
      margin: 0;
      padding: 0;
      color: #fff;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }

    h2, h3 {
      text-align: center;
      color: #ffdd57;
    }

    .section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    input, select, button {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      background: #ffdd57;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #ffc107;
      transform: scale(1.05);
    }

    #employeeList div, #tasksContainer div {
      background: rgba(255, 255, 255, 0.2);
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logout {
      text-align: right;
    }

    .status {
      font-weight: bold;
    }

    .status.pending {
      color: orange;
    }
    .status.completed {
      color: lightgreen;
    }
    .status.canceled {
      color: red;
    }

    .search-bar {
      margin: 10px 0;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-actions button {
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logout">
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <h2><i class="fas fa-user-shield"></i> Admin Dashboard</h2>
    <p id="adminInfo"><i class="fas fa-user"></i> Welcome, Admin</p>

    <!-- Assign Task Section -->
    <div class="section">
      <h3><i class="fas fa-tasks"></i> Assign Task to Employee</h3>
      <form id="assignForm">
        <input type="text" id="taskTitle" placeholder="Task Title" required>
        <input type="text" id="taskDesc" placeholder="Task Description" required>
        <select id="employeeSelect" required>
          <option value="">Select Employee</option>
        </select>
        <button type="submit" class="assignTaskBtn"><i class="fas fa-plus-circle"></i> Assign Task</button>
      </form>
    </div>

    <!-- Employee List Section -->
    <div class="section">
      <h3><i class="fas fa-users"></i> Employee List</h3>
      <input type="text" id="searchEmployee" class="search-bar" placeholder="ðŸ” Search Employee">
      <div id="employeeList">Loading employees...</div>
    </div>

    <!-- Task List Section -->
    <div class="section">
      <div class="task-header">
        <h3><i class="fas fa-clipboard-list"></i> All Tasks</h3>
        <select id="taskFilter">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
          <option value="canceled">Canceled</option>
        </select>
      </div>
      <div id="tasksContainer">Loading tasks...</div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Ensure only admins can access this page
      fetch('/me')
        .then(r => r.ok ? r.json() : null)
        .then(user => {
          if(!user || user.role !== 'admin') {
            window.location.href = 'index.html';
          }
        });
      const employeeSelect = document.getElementById("employeeSelect");
      const employeeList = document.getElementById("employeeList");
      const tasksContainer = document.getElementById("tasksContainer");
      const searchEmployee = document.getElementById("searchEmployee");
      const taskFilter = document.getElementById("taskFilter");

      // Fetch Employees
      function fetchEmployees() {
        fetch("/admin/employees")
          .then(res => res.json())
          .then(data => {
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            employeeList.innerHTML = "";
            data.forEach(emp => {
              let option = document.createElement("option");
              // Backend expects employeeId as employee_id string
              option.value = emp.employee_id;
              option.textContent = emp.username;
              employeeSelect.appendChild(option);

              let div = document.createElement("div");
              div.innerHTML = `
                <div><i class="fas fa-user"></i> ${emp.username} (ID: ${emp.employee_id})</div>
                <div class="task-actions">
                  <button onclick="promoteEmployee(${emp.id})"><i class="fas fa-arrow-up"></i> Promote</button>
                </div>
              `;
              employeeList.appendChild(div);
            });

            // Employee search filter
            searchEmployee.addEventListener("input", () => {
              const query = searchEmployee.value.toLowerCase();
              Array.from(employeeList.children).forEach(div => {
                div.style.display = div.textContent.toLowerCase().includes(query) ? "" : "none";
              });
            });
          });
      }

      // Fetch Tasks
      function fetchTasks() {
        fetch("/tasks")
          .then(res => res.json())
          .then(data => {
            renderTasks(data);
          });
      }

      // Render Tasks with Filters + Icons
      function renderTasks(tasks) {
        tasksContainer.innerHTML = "";
        const filter = taskFilter.value;

        tasks
          .filter(task => {
            if(filter === 'all') return true;
            const status = task.status.toLowerCase();
            if(filter === 'pending') return status === 'assigned' || status === 'pending';
            return status === filter;
          })
          .forEach(task => {
            let statusIcon = {
              assigned: '<i class="fas fa-hourglass-half" style="color:orange;"></i>',
              pending: '<i class="fas fa-hourglass-half" style="color:orange;"></i>',
              completed: '<i class="fas fa-check-circle" style="color:lightgreen;"></i>',
              canceled: '<i class="fas fa-times-circle" style="color:red;"></i>'
            }[task.status.toLowerCase()] || "";

            let div = document.createElement("div");
            div.innerHTML = `
              <div>
                <strong><i class="fas fa-briefcase"></i> ${task.title}</strong><br>
                ${task.description}<br>
                Status: ${statusIcon} <span class="status ${task.status.toLowerCase()}">${task.status}</span>
              </div>
              <div class="task-actions">
                <button onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i> Delete</button>
              </div>
            `;
            tasksContainer.appendChild(div);
          });
      }

      // Assign Task
      document.getElementById("assignForm").addEventListener("submit", e => {
        e.preventDefault();
        const title = document.getElementById("taskTitle").value;
        const desc = document.getElementById("taskDesc").value;
        const empId = employeeSelect.value;

        fetch("/admin/assign-task", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, description: desc, employeeId: empId })
        })
          .then(res => res.text())
          .then((msg) => {
            alert(msg || "âœ… Task Assigned!");
            fetchTasks();
          })
          .catch(() => alert('Failed to assign task'));
      });

      // Promote Employee
      window.promoteEmployee = function(id) {
        fetch(`/api/employees/${id}/promote`, { method: "PUT" })
          .then(res => res.json())
          .then(() => {
            alert("ðŸš€ Employee Promoted!");
            fetchEmployees();
          });
      };

      // Delete Task
      window.deleteTask = function(id) {
        if (confirm("Are you sure you want to delete this task?")) {
          fetch(`/api/tasks/${id}`, { method: "DELETE" })
            .then(() => {
              alert("ðŸ—‘ï¸ Task Deleted!");
              fetchTasks();
            });
        }
      };

      // Filter Tasks
      taskFilter.addEventListener("change", fetchTasks);

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch('/logout', { method: 'POST' });
        window.location.href = 'index.html';
      });

      fetchEmployees();
      fetchTasks();
    });
  </script>
</body>
</html>
